# Week 4: 統合テクニカル分析 - 三位一体で判断する

**前提**: [Week 3](./03_macd_practical.md)でMACD実践完了

**所要時間**: 4-5時間

---

## 登場人物

**あなた（tatut）** - Week 3でMACDをマスター
**ミコ** - AIトレーダー（Claude Code）、統合分析を教える

---

## 📖 Part 1: これまでの武器を整理（事前ストーリー）

### Scene 1: Week 3の振り返り

**ミコ**: 「Week 3まで終わったな。今、どんな武器を持ってる？」

**あなた**: 「...RSI、MACD」

**ミコ**: 「そうだ。それぞれ役割がある」

```
【今持っている武器】

RSI（Week 2）:
- 役割: 買われすぎ/売られすぎ判定
- 弱点: トレンドの方向はわからない

MACD（Week 3）:
- 役割: トレンドの方向と勢い
- 弱点: 買われすぎ/売られすぎはわからない

問題:
単体では不十分。組み合わせが必要。
```

**ミコ**: 「今日は、もう一つの武器と、3つを組み合わせる方法を学ぶ」

---

## 🗣️ 対話ポイント1：現在のポートフォリオの総合分析

**ミコ**: 「まず、今のポートフォリオを総合的に分析しよう」

👉 **あなたの番です**

**教えてほしいこと**:
- 現在保有している全銘柄
- Week 3で決めたアクション（保持/損切り/新規購入）を実行しましたか？
- 現在の損益

**例**:
```
「DOGE: 保持中 (+8.5%)
 SHIB: 損切りした (-3.2%)
 LINK: 新規購入した (購入価格 $15.20)」
```

---

## 📊 Part 2: あなたのデータで統合分析（ここはClaude生成）

※ **あなたがポートフォリオを教えてくれたら、ここに総合分析を生成します**

**生成される内容**:
- 各銘柄のRSI、MACD、ボリンジャーバンド
- 3つの指標を組み合わせた総合スコア
- アクションプラン（買い/保持/売り）
- リスク評価

**例**:
```
ミコ: 「じゃあ、全銘柄を総合分析しよう」

[実際のデータ取得]

DOGE:
  RSI: 62.5（中立）
  MACD: ゴールデンクロス（上昇トレンド）
  BB: 中央付近
  総合スコア: 75/100（良好）
  判定: 保持継続

LINK:
  RSI: 45.3（中立）
  MACD: ゴールデンクロス直後（上昇開始）
  BB: 下限付近（反発の可能性）
  総合スコア: 82/100（優良）
  判定: 良い購入タイミングだった！

ミコ: 「LINKは3つの指標がすべて良好だ。Week 0-3の知識を使えてるな」
```

---

## 📚 Part 3: ボリンジャーバンドの発明（事前ストーリー）

### Scene 2: 1980年代初頭、カリフォルニア

**ミコ**: 「3つ目の武器、ボリンジャーバンドの話をしよう」

---

### 【回想シーン: ボリンジャーの疑問】

**場所**: カリフォルニア、投資顧問会社

**ジョン・ボリンジャー** (若手アナリスト):
「クライアントから毎日聞かれる...」

**クライアント**: 「今、買っても大丈夫ですか？」

**ボリンジャー**: 「それに答えるには...『今の価格が異常かどうか』を判断する必要がある」

**ボリンジャー**: 「でも、何が『正常』で、何が『異常』なのか？」

*机の上には株価チャート。激しく上下する価格*

**ボリンジャー**: 「価格は常に動いている」

**ボリンジャー**: 「静かな時もあれば、荒れる時もある」

**ボリンジャー**: 「**ボラティリティ（変動幅）が変わる**んだ」

---

### 固定幅バンドの失敗

**ボリンジャー**: 「最初は、移動平均線の上下に固定幅のバンドを引いてみた」

```
【固定幅バンド（失敗作）】

Upper Band = MA(20) + $5
Middle Band = MA(20)
Lower Band = MA(20) - $5

問題:
- 価格が$100の時: ±$5は狭すぎる（すぐ突破）
- 価格が$10の時: ±$5は広すぎる（届かない）

→ 価格水準によって、適切な幅が変わる
```

**ボリンジャー**: 「ダメだ...固定幅じゃ意味がない」

---

### 標準偏差との出会い

**ボリンジャー**: （大学時代の統計学の教科書を開く）

```
【標準偏差（σ: シグマ）】

定義:
データの「ばらつき」を測る指標

正規分布の性質:
- 平均 ± 2σ の範囲: データの約95%が含まれる
- つまり、2σの外 = 異常値（上位/下位2.5%）

例（テストの点数）:
平均: 60点、標準偏差: 10点
→ 40-80点の範囲に約95%の生徒
→ 80点以上は「異常に高い」（上位2.5%）
```

**ボリンジャー**: 「...これだ！」

**ボリンジャー**: 「価格の標準偏差を使えば、『正常範囲』が定義できる！」

**ボリンジャー**: 「そして、範囲の外 = 異常 = リスク高い」

---

### Bollinger Bandsの誕生

**ボリンジャー**: （興奮してペンを走らせる）

```
【Bollinger Bands 数式】

Middle Band = SMA(20)
（20日間の単純移動平均）

Upper Band = SMA(20) + (2 × σ)
Lower Band = SMA(20) - (2 × σ)

σ = 標準偏差（過去20日間）

解釈:
- 価格がバンド内: 正常範囲（安全）
- 価格がバンド外: 異常範囲（危険）
- バンド幅拡大: ボラティリティ増加
- バンド幅縮小: ボラティリティ減少
```

**ボリンジャー**: （過去チャートで検証）

**ボリンジャー**: 「...完璧だ！」

**ボリンジャー**: 「価格がUpper Bandを超えた → 買われすぎ → その後下落」

**ボリンジャー**: 「価格がLower Bandを下回った → 売られすぎ → その後反発」

**ボリンジャー**: 「そして、バンド幅が縮んだ後、必ず大きく動いてる！」

---

### Scene 3: 現代、tatutとミコ

**あなた**: 「...標準偏差か」

**ミコ**: 「そう。ボリンジャーは、価格を『確率』で捉えた」

**ミコ**: 「じゃあ、実装を見よう」

---

## 💻 Part 4: ボリンジャーバンドの実装

### Pythonでの実装

```python
def calculate_bollinger_bands(prices: pd.Series,
                               period: int = 20,
                               num_std: float = 2.0) -> pd.DataFrame:
    """
    Bollinger Bands を計算

    Args:
        prices: 終値のSeries
        period: 期間（デフォルト20）
        num_std: 標準偏差の倍数（デフォルト2.0）

    Returns:
        DataFrame（upper, middle, lower, bandwidth, percent_b）
    """
    # Middle Band（移動平均）
    middle = prices.rolling(window=period).mean()

    # 標準偏差
    std = prices.rolling(window=period).std()

    # Upper/Lower Band
    upper = middle + (num_std * std)
    lower = middle - (num_std * std)

    # Band Width（バンドの幅）
    bandwidth = (upper - lower) / middle

    # %B（価格のバンド内位置）
    percent_b = (prices - lower) / (upper - lower)

    return pd.DataFrame({
        'upper': upper,
        'middle': middle,
        'lower': lower,
        'bandwidth': bandwidth,
        'percent_b': percent_b
    })
```

---

### %B（パーセントB）とは

```
【%Bの意味】

%B = (現在価格 - Lower Band) / (Upper Band - Lower Band)

値の解釈:
- %B = 1.0: Upper Band上（買われすぎ）
- %B = 0.5: Middle Band上（中央）
- %B = 0.0: Lower Band上（売られすぎ）

- %B > 1.0: バンドを上抜け（異常に買われすぎ）
- %B < 0.0: バンドを下抜け（異常に売られすぎ）
```

---

### バンド幅（Bandwidth）

```
【バンド幅の意味】

Bandwidth = (Upper - Lower) / Middle

値の解釈:
- 大きい: ボラティリティ高（価格が激しく動く）
- 小さい: ボラティリティ低（価格が静か）

スクイーズ（収縮）:
バンド幅が縮小 → 嵐の前の静けさ
→ その後、大きく動く可能性

エクスパンション（拡大）:
バンド幅が拡大 → トレンド発生中
```

---

## 🎓 Part 5: RSI + MACD + BB 統合分析

### 統合スコアリングシステム

**ミコ**: 「3つの指標を組み合わせると、こうなる」

```python
def calculate_integrated_score(rsi: float, macd_histogram: float,
                                bb_percent_b: float, bb_bandwidth: float) -> dict:
    """
    RSI + MACD + BBの統合スコア

    Returns:
        {
            'score': 0-100,
            'signal': 'strong_buy' | 'buy' | 'hold' | 'sell' | 'strong_sell',
            'details': {...}
        }
    """
    score = 50  # 中立からスタート

    # RSI評価（30点満点）
    if rsi < 30:
        score += 30  # 売られすぎ（買いチャンス）
    elif rsi < 50:
        score += 20  # やや売られ気味
    elif rsi < 70:
        score += 10  # 中立
    else:
        score -= 20  # 買われすぎ（危険）

    # MACD評価（30点満点）
    if macd_histogram > 0:
        score += 30 if macd_histogram > 0.0001 else 15
    else:
        score -= 30 if macd_histogram < -0.0001 else -15

    # BB評価（20点満点）
    if bb_percent_b < 0.2:
        score += 20  # 下限付近（買いチャンス）
    elif bb_percent_b > 0.8:
        score -= 20  # 上限付近（危険）
    else:
        score += 10  # バンド内（安全）

    # ボーナス: スクイーズ検出（+10点）
    if bb_bandwidth < 0.05:
        score += 10  # 大きな動きの予兆

    # 判定
    if score >= 80:
        signal = 'strong_buy'
    elif score >= 65:
        signal = 'buy'
    elif score >= 35:
        signal = 'hold'
    elif score >= 20:
        signal = 'sell'
    else:
        signal = 'strong_sell'

    return {
        'score': min(max(score, 0), 100),
        'signal': signal,
        'details': {
            'rsi': rsi,
            'macd_histogram': macd_histogram,
            'bb_percent_b': bb_percent_b,
            'bb_bandwidth': bb_bandwidth
        }
    }
```

---

### 統合判断のパターン

```
【統合判断パターン】

## パターン1: 強い買いシグナル（スコア 80+）
✅ RSI < 30（売られすぎ）
✅ MACDゴールデンクロス（上昇開始）
✅ BB下限付近（反発の可能性）
✅ バンド幅縮小中（スクイーズ）
→ 強気！買いチャンス

## パターン2: 中立（スコア 50前後）
⚠️ RSI 40-60（中立）
⚠️ MACDヒストグラム小さい（方向感なし）
⚠️ BB中央付近
→ 様子見

## パターン3: 強い売りシグナル（スコア 20未満）
❌ RSI > 70（買われすぎ）
❌ MACDデッドクロス（下降開始）
❌ BB上限突破（異常）
→ 危険！損切り検討

## パターン4: 注意（矛盾シグナル）
⚠️ RSI < 30 だが MACDデッドクロス
→ 売られすぎだが下降トレンド
→ さらに下がる可能性（待つ）
```

---

## 🗣️ 対話ポイント2：新しい銘柄を統合分析

**ミコ**: 「統合スコアリングで、新しい銘柄を探してみるか？」

👉 **あなたの番です**

**やること**:
1. MEXCで気になる銘柄を3-5個選ぶ
2. ダッシュボードで確認
3. 銘柄名を教えてください

**例**:
```
「ミコ、ATOM、LTC、AAVE、CRVが気になる」
```

---

## 📊 Part 6: 複数銘柄の比較分析（ここはClaude生成）

※ **あなたが銘柄を教えてくれたら、ここに比較分析を生成します**

**生成される内容**:
- 各銘柄の統合スコア
- ランキング
- 最も買いやすい銘柄の推奨
- リスク評価

**例**:
```
[統合スコアランキング]

1. ATOM: 85/100（強い買い）
   RSI: 28.5, MACD: ゴールデンクロス, BB: 下限付近
   → 3つの指標が完璧！

2. AAVE: 72/100（買い）
   RSI: 42.3, MACD: ゴールデンクロス, BB: 中央
   → トレンドは良好

3. CRV: 55/100（中立）
   RSI: 58.2, MACD: 横ばい, BB: 中央
   → 様子見

4. LTC: 35/100（売り）
   RSI: 73.1, MACD: デッドクロス, BB: 上限付近
   → 買われすぎ、危険

ミコ: 「ATOMが一番スコアが高い。3つの指標がすべて買いを示してる」
ミコ: 「どうする？買ってみるか？」
```

---

## 🗣️ 対話ポイント3：購入判断

**ミコ**: 「統合分析の結果を見て、どうする？」

**選択肢**:
1. **最高スコアの銘柄を購入**: データに基づいた判断
2. **複数銘柄に分散**: リスク分散
3. **見送り**: もう少し様子見

👉 **あなたの判断を聞かせてください**

---

## 📝 Week 4のまとめ

### 今回学んだこと

1. **ボリンジャーバンドの発明**
   - ボリンジャーの問題意識
   - 標準偏差を使った「正常範囲」の定義
   - スクイーズとエクスパンション

2. **統合スコアリングシステム**
   - RSI + MACD + BBの組み合わせ
   - 各指標の重み付け
   - 総合スコアでの判断

3. **実践的な統合分析**
   - 自分のポートフォリオの総合評価
   - 複数銘柄の比較
   - データに基づいた購入判断

4. **矛盾シグナルの扱い**
   - RSIとMACDが逆を示す場合
   - 慎重に判断する

---

## ✅ Week 4 完了チェックリスト

- [ ] 現在のポートフォリオの統合分析
- [ ] ボリンジャーバンドの発明ストーリーを理解
- [ ] %Bとバンド幅の意味を理解
- [ ] スクイーズとエクスパンションを理解
- [ ] 統合スコアリングシステムを理解
- [ ] 複数銘柄の統合分析を実施
- [ ] 統合スコアに基づいた購入判断
- [ ] Week 0-4の知識を実践で活用

---

## 🎓 次のステップ

**Week 5**: ARIMA/GARCH予測モデル
- 時系列分析の基礎
- 価格予測モデル
- 統計的手法の活用

---

## 📚 参考資料

- [Week 0: 基礎知識](./00_foundations.md) - ボリンジャーバンドの基本
- [Week 2: RSI実践](./02_rsi_practical.md) - RSI復習
- [Week 3: MACD実践](./03_macd_practical.md) - MACD復習
- [docs/ANALYSIS_METHODS.md](../docs/ANALYSIS_METHODS.md) - 統合分析の詳細
- [Streamlitダッシュボード](../dashboard/main.py) - 統合分析の可視化

---

## 🎓 復習クイズ

### Q1: %B = 0.95 の意味は？
<details>
<summary>答えを見る</summary>
**Upper Band付近（買われすぎ）**。%B = 1.0がUpper Band上なので、0.95はその直下。買われすぎの可能性。
</details>

### Q2: バンド幅が急に縮小した。これは？
<details>
<summary>答えを見る</summary>
**スクイーズ（収縮）**。ボラティリティ低下。嵐の前の静けさ。その後、大きく動く可能性。
</details>

### Q3: RSI 28、MACDゴールデンクロス、BB下限。統合スコアは？
<details>
<summary>答えを見る</summary>
**80点以上（強い買い）**。3つの指標がすべて買いシグナル。理想的な購入タイミング。
</details>

### Q4: RSI 25、MACDデッドクロス。どうする？
<details>
<summary>答えを見る</summary>
**待つ**。RSIは売られすぎだがMACDは下降トレンド。矛盾シグナル。さらに下がる可能性があるため慎重に。
</details>

---

**次のステップ**: [Week 5: ARIMA/GARCH予測](./05_arima_garch.md)

---

**最終更新**: 2025-11-02
**作成者**: Claude Code (with tatut)
